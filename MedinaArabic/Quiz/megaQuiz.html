<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible"
    content="IE=edge">
    <meta name="viewport"
    content="width=device-width, initial-scale=1.0">
    <title>Quiz</title>
    <link rel="stylesheet"
    href="style.css">
    <link rel="icon"
    href="./favicon.png">
</head>

<body>
    <div class="flex">
        <div class="lessonmenu"
        id="menuContainer">
        </div>
        <main>
            <h4 id="queText"></h4>
            <div class="flexgrid"
            id="choices">
            </div>
        </main>
    </div>


</body>
<script type="module">
    import createMenu, { newmin, newmax } from './quizmenu.js'
    const urlBook1 = "../book1edit.json"
    const queText = document.getElementById("queText")
    const optionsContainer = document.getElementById("choices")
    const menuContainer = document.getElementById("menuContainer")
    let min, max, questionText
    let NoOfAnsOptionsToShow = 6, NoOfAnsOptions
    let outputIDs = [], resultID
    let book1

    // quickly fire through each question
    document.onkeydown = function (evt) {
        evt = evt || window.event;
        // on z keypress
        if (evt.keyCode == 90) {
            setNextQuestion()
        }
    }

    // get lesson vocab from json file
    let getVocab = () => {
        fetch(urlBook1)
            .then((response) => response.json()) // return json object
            .then((data) => {
                book1 = data
                let noOfLessons = book1[book1.length - 1].L
                createMenu(noOfLessons, book1, setNextQuestion)
            })
            .catch((error) => {
                console.error("Error:", error)
            })
    }

    let startMegaQuiz = () => {
        min = 0
        max = book1.length
        setNextQuestion()
    }



    let setNextQuestion = () => {
        min = newmin() == undefined ? min : newmin()
        max = newmax() == undefined ? max : newmax()
        // console.log("min: " + min + "  Max" + max)
        //remove previous options for next selection (reset state)
        while (optionsContainer.hasChildNodes()) {
            optionsContainer.removeChild(optionsContainer.firstChild)
        }
        // show less options if a smaller lesson is chosen
        let vocabAmount = max - min
        NoOfAnsOptions =
            vocabAmount < NoOfAnsOptionsToShow ? vocabAmount : NoOfAnsOptionsToShow
        // Get new vocab ID
        getRndIDs(min, max)
        // Select first ID as answer result
        resultID = outputIDs[0]
        // Update question text 
        questionText = book1[outputIDs[0]].En
        queText.innerHTML = questionText
        // Randomise ID order for output
        outputIDs = shuffleArr(outputIDs)
        // display output options
        outputIDs.forEach(createOptions)
    }

    let getRndIDs = (min, max) => {
        outputIDs = [] // Clear array
        while (outputIDs.length < NoOfAnsOptions) {
            var r = Math.floor(Math.random() * (max - min)) + min
            if (outputIDs.indexOf(r) === -1) outputIDs.push(r)
        }
    }

    let createOptions = (value) => {
        var ansOption = document.createElement("p")
        ansOption.innerHTML = book1[value].Ar
        ansOption.classList.add("optionchoice")
        if (resultID === value) {
            ansOption.id = "ans"
            ansOption.onclick = function () { // alert("corect")
                setNextQuestion()
            }
        } else { // if wrong answer selected
            ansOption.onclick = function () {
                ansOption.style.backgroundColor = "darkred"
            }
        }
        optionsContainer.appendChild(ansOption)
    }

    const shuffleArr = (array) =>
        array
            .map((a) => ({ sort: Math.random(), value: a }))
            .sort((a, b) => a.sort - b.sort)
            .map((a) => a.value)

        // self executing function here / same as jquery document ready
        ; (function () {
            getVocab()
            setTimeout(startMegaQuiz, 1000)
        })()

</script>

</html>